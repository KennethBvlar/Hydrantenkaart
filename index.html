<!doctype html>
<html lang="nl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Hydrantenkaart (Publiek)</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
<style>
html, body, #map { height: 100%; margin: 0; }
.legend { background:#fff; padding:8px 10px; border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,.15); font: 14px/1.2 system-ui, sans-serif; }
.legend div { margin: 4px 0; display:flex; align-items:center; gap:6px; }
.dot { width:12px; height:12px; border-radius:50%; border:1px solid #333; display:inline-block; }
</style>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Hydrantenkaart (Publiek)</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
  <style>
    html, body, #map { height: 100%; margin: 0; }
    .ui { position: absolute; top: 10px; left: 10px; z-index: 1000; display: flex; gap: 8px; align-items: center; }
    .search {
      background:#fff; padding:8px 10px; border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,.15);
      font: 14px/1.2 system-ui, sans-serif; width: 280px; border: 1px solid #ddd;
    }
    .legend { position: absolute; top: 10px; right: 10px; z-index: 1000;
      background:#fff; padding:8px 10px; border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,.15); font: 14px/1.2 system-ui, sans-serif; }
    .legend div { margin: 4px 0; display:flex; align-items:center; gap:6px; }
    .dot { width:12px; height:12px; border-radius:50%; border:1px solid #333; display:inline-block; }
    .pill { background:#fff; padding:6px 10px; border-radius:999px; border:1px solid #ddd; font: 13px system-ui, sans-serif; }
  </style>
</head>
<body>
<div id="map"></div>
  <div id="map"></div>

  <!-- UI -->
  <div class="ui">
    <input id="q" class="search" placeholder="Zoeken op straat, gemeente of hydrantnr…" />
    <span id="count" class="pill">0 resultaten</span>
  </div>
  <div class="legend">
    <div><span class="dot" style="background:#2ecc71"></span>Bruikbaar</div>
    <div><span class="dot" style="background:#e74c3c"></span>Niet bruikbaar</div>
    <div><span class="dot" style="background:#9b59b6"></span>Onvindbaar</div>
    <div><span class="dot" style="background:#95a5a6"></span>Onbekend</div>
  </div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <script>
const PROJECT_URL = "https://yusqcjxkwhxvxubzzhog.supabase.co"; // ← vervang
const ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl1c3Fjanhrd2h4dnh1Ynp6aG9nIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgxMzAxNTUsImV4cCI6MjA3MzcwNjE1NX0.wDHkD8MLvDVlmzgF246ArKDyuJPwp6ripOrWWNDar9E"; // ← vervang


// Kaart opstarten (Brussel als start)
const map = L.map('map').setView([50.85, 4.35], 11);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
attribution: '&copy; OpenStreetMap-bijdragers'
}).addTo(map);
// Kaart
  const map = L.map('map').setView([50.85, 4.35], 11);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap-bijdragers'
  }).addTo(map);

  // Status → kleur
  function statusColor(s){
    const v = (s||'').toLowerCase();
    if(v==='bruikbaar') return '#2ecc71';
    if(v==='niet bruikbaar') return '#e74c3c';
    if(v==='onvindbaar') return '#9b59b6';
    if(v==='onbekend') return '#95a5a6';
    return '#3498db';
  }

// Status → kleur
function statusColor(s){
switch((s||'').toLowerCase()){
case 'bruikbaar': return '#2ecc71';
case 'niet bruikbaar': return '#e74c3c';
case 'onvindbaar': return '#9b59b6';
case 'onbekend': return '#95a5a6';
default: return '#3498db';
}
}
  const markers = L.layerGroup().addTo(map);
  let allRows = [];   // originele set (genormaliseerd)
  let showing = [];   // gefilterde set

  // Helpers
  const toLowerKeys = obj => Object.fromEntries(Object.entries(obj).map(([k,v]) => [k.toLowerCase(), v]));
  const norm = r => {
    r = toLowerKeys(r);
    // zorg dat we overal dezelfde key-namen gebruiken
    return {
      hydrantnr: r.hydrantnr ?? r.code ?? '',
      straat: r.straat ?? '',
      gemeente: r.gemeente ?? '',
      plaats: r.plaats ?? '',
      typehydrant: r.type ?? r.typehydrant ?? '',
      typeaanduiding: r.type_aanduiding ?? r.typeaanduiding ?? '',
      diameter: r.diameter ?? r.diameter_mm ?? null,
      status: (r.status ?? '').toString().replace('_',' '),
      lat: typeof r.lat==='number' ? r.lat : Number(r.lat),
      lon: typeof r.lon==='number' ? r.lon : Number(r.lon),
    };
  };

const markers = L.layerGroup().addTo(map);
  function render(rows){
    markers.clearLayers();
    rows.forEach(r => {
      if(!isFinite(r.lat) || !isFinite(r.lon)) return;
      const m = L.circleMarker([r.lat, r.lon], { radius: 7, weight:1, color:'#333', fillColor: statusColor(r.status), fillOpacity: 0.9 });
      m.bindPopup(
        `<b>${r.hydrantnr}</b><br>` +
        `${r.straat || ''}${r.gemeente ? ', '+r.gemeente : ''}<br>` +
        (r.plaats ? `${r.plaats}<br>` : '') +
        `Type: ${r.typehydrant || '-'}${r.typeaanduiding ? ' – '+r.typeaanduiding : ''}<br>` +
        (r.diameter ? `Diameter: ${r.diameter} mm<br>` : '') +
        `Status: ${r.status}`
      );
      markers.addLayer(m);
    });
    document.getElementById('count').textContent = `${rows.length} resultaten`;
    const latlngs = rows.filter(r=>isFinite(r.lat)&&isFinite(r.lon)).map(r=>[r.lat,r.lon]);
    if(latlngs.length){ map.fitBounds(latlngs, { padding:[20,20] }); }
  }

  async function loadHydrants(){
    const url = `${PROJECT_URL}/rest/v1/hydrants_public?select=*`;
    const res = await fetch(url, { headers: { apikey: ANON_KEY, Authorization: `Bearer ${ANON_KEY}` } });
    if(!res.ok){ alert('Kon data niet laden'); return; }
    const raw = await res.json();
    allRows = raw.map(norm);
    showing = allRows.slice();
    render(showing);
  }

async function loadHydrants(){
const url = `${PROJECT_URL}/rest/v1/hydrants_public?select=*`;
const res = await fetch(url, { headers: { apikey: ANON_KEY, Authorization: `Bearer ${ANON_KEY}` } });
if(!res.ok){ alert('Kon data niet laden'); return; }
const rows = await res.json();
markers.clearLayers();
rows.forEach(r => {
if(typeof r.Lat !== 'number' || typeof r.Lon !== 'number') return;
const m = L.circleMarker([r.Lat, r.Lon], { radius: 7, weight:1, color:'#333', fillColor: statusColor(r.Status), fillOpacity: 0.9 });
m.bindPopup(``
+ `<b>${r.Hydrantnr}</b><br>`
+ `${r.Straat || ''}${r.Gemeente ? ', '+r.Gemeente : ''}<br>`
+ (r.Plaats ? `${r.Plaats}<br>` : '')
+ `Type: ${r.Typehydrant || '-'}${r.typeAanduiding ? ' – '+r.typeAanduiding : ''}<br>`
+ (r.diameter ? `Diameter: ${r.diameter} mm<br>` : '')
+ `Status: ${r.Status}`
);
markers.addLayer(m);
});
if(rows.length){
const latlngs = rows.filter(r=>typeof r.Lat==='number'&&typeof r.Lon==='number').map(r=>[r.Lat,r.Lon]);
if(latlngs.length){ map.fitBounds(latlngs, { padding:[20,20] }); }
}
}
  // Zoeken
  const q = document.getElementById('q');
  let timer = null;
  q.addEventListener('input', () => {
    clearTimeout(timer);
    timer = setTimeout(() => {
      const term = q.value.trim().toLowerCase();
      if(!term){ showing = allRows.slice(); render(showing); return; }
      showing = allRows.filter(r =>
        (r.hydrantnr||'').toLowerCase().includes(term) ||
        (r.straat||'').toLowerCase().includes(term) ||
        (r.gemeente||'').toLowerCase().includes(term)
      );
      render(showing);
    }, 150); // debounce
  });


// Legende
const legend = L.control({position: 'topright'});
legend.onAdd = function(){
const div = L.DomUtil.create('div', 'legend');
div.innerHTML = `
<div><span class="dot" style="background:#2ecc71"></span>Bruikbaar</div>
<div><span class="dot" style="background:#e74c3c"></span>Niet bruikbaar</div>
<div><span class="dot" style="background:#9b59b6"></span>Onvindbaar</div>
<div><span class="dot" style="background:#95a5a6"></span>Onbekend</div>
`;
return div;
};
legend.addTo(map);


loadHydrants();
</script>
  loadHydrants();
  </script>
</body>
</html>

